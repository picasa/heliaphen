---
title: "Heliaphen"
output:
  flexdashboard::flex_dashboard:
    source_code: embed
runtime: shiny
---

```{r header, include=FALSE}
library(lubridate)
library(readr)
library(readxl)
library(plyr)
library(dplyr)
library(ggplot2)
library(ggrepel)
library(scales)
library(flexdashboard)
library(rheliaphen)
library(shiny)

# experiment parameters
data_trial <- reactive({
  read_excel(paste0("data/heliaphen_experiments.xlsx")) %>% 
    mutate(start=ymd(start, tz="Europe/Paris"), end=ymd(end, tz="Europe/Paris")) %>% 
    filter(experiment==input$experiment)
})

list_experiment <- reactive({
  read_excel(paste0("data/heliaphen_experiments.xlsx")) %>% select(experiment) %>% arrange(experiment) %>% .$experiment
})

# design of experiment
data_index <- reactive({
  read_excel(paste0("data/",input$experiment,"/",input$experiment,"_index.xlsx"))
})

# list of genotypes in selected experiment
list_genotype <- reactive({
  data_index() %>% select(genotype) %>% distinct() %>% arrange(genotype) %>% .$genotype
})

# pot weight
data_weight <- reactive({
  read_rds(paste0("data/",input$experiment,"/",input$experiment,"_weight.rds")) 
})

# soil water deficit
data_ftsw <- reactive({
  data_weight() %>%
    soil_water_deficit(
      index=data_index(),
      date_start=data_trial()$start,
      date_end=data_trial()$end,
      weight_dead=data_trial()$weight_dead,
      awc=0.39,
      timing="measure"
    ) 
})

data_ftsw_label <- reactive({
  data_ftsw() %>%
    filter(genotype == input$genotype) %>%
    group_by(treatment, genotype, plant_code) %>%
    arrange(time) %>%
    filter(row_number()==n())
})

# interpolated soil water deficit
data_ftsw_daily <- reactive({
  data_weight() %>%
    soil_water_deficit(
      index=data_index(),
      date_start=data_trial()$start,
      date_end=data_trial()$end,
      weight_dead=data_trial()$weight_dead,
      awc=0.39,
      timing="daily"
    ) 
})

data_ftsw_daily_label <- reactive({
  data_ftsw_daily() %>%
    filter(genotype == input$genotype) %>%
    group_by(treatment, genotype, plant_code) %>%
    arrange(time) %>%
    filter(row_number()==n()-1)
})


# table for stressed plant below defined water deficit threshold
table_harvest <- reactive({
  data_ftsw_daily() %>%
    plant_harvest(
      date_start=ymd(as.character(input$date[1], tz="Europe/Paris")),
      date_end=ymd(as.character(input$date[2]), tz="Europe/Paris"),
      threshold=input$threshold_ftsw
    )
})

```


Sidebar {.sidebar}
=====================================
```{r inputs_design}

# shiny input for file selection (list)
# TODO : read existing dir
renderUI({
  selectInput('experiment', 'Experiment', list_experiment())
})
  
# shiny input for genotype selection (list)
renderUI({
  selectInput('genotype', 'Genotype', list_genotype())
})

# shiny input for interpolation (check)

```

----------

```{r inputs_harvest}
# shiny input for planning date selection
renderUI({
  dateRangeInput('date', label='Dates', start=data_trial()$start, end=data_trial()$end)
})
  
# shiny input for filtering threshold
renderUI({
  sliderInput("threshold_ftsw", label="Threshold", min=0, max=1, value=0.1)
})

# setup data download
output$table_download_area <- downloadHandler(
  file = paste0(input$experiment, "_", format(Sys.Date(), "%Y%m%d"),"_area.csv"), 
  content = function(file) {
    write_csv(write_heliaphen(table_harvest())$area, file, na="")
  }
)

renderUI({
  downloadLink('table_download_area', label = 'Download (leaf area)')  
})
  
output$table_download_architecture <- downloadHandler(
  file = paste0(input$experiment, "_", format(Sys.Date(), "%Y%m%d"),"_architecture.csv"), 
  content = function(file) {
    write_csv(write_heliaphen(table_harvest())$architecture, file, na="")
  }
)

renderUI({
  downloadLink('table_download_architecture', label = 'Download (architecture)')
})

```


Design {data-orientation=rows}
=====================================  
    
Row {data-height=250}
-------------------------------------
    
### Experimental design
```{r plot_design}
# plot experimental design
renderPlot({
  data_index() %>% 
    ggplot(aes(as.factor(column), as.factor(line))) +
    geom_tile(aes(fill=genotype), alpha=0.5) +
    geom_point(aes(shape=treatment), size=5, alpha=0.5) +
    scale_shape_manual(values=c(19, 1), guide = "none") +
    labs(x=NULL, y=NULL) + coord_equal() + theme_bw() +
    theme(legend.position="bottom")
})

```


Row {data-height=600}
-------------------------------------

### Table of harvestable plants
```{r table_harvest}

renderDataTable(
  table_harvest() %>%
    mutate(
      weight=round(weight, 0),
      FTSW=round(FTSW, 2),
      irrigation=round(irrigation, 0)
    ),
  options=list(pageLength=10)
)

```



Weight
=====================================     
   
Row  {.tabset}
-------------------------------------

### All genotypes
```{r plot_weight}

renderPlot({
  data_weight() %>%
    ggplot(aes(x=time, y=weight, color=treatment, group=interaction(genotype, treatment))) +
    geom_point(alpha=0.3) +
    geom_line(stat="smooth", method="loess", alpha=0.8, size=1) +
    geom_hline(aes(yintercept=0.1), linetype=2) +  
    scale_color_manual(values=c("#619CFF","#F8766D")) +
    scale_x_datetime(
      date_breaks="1 day", labels=date_format("%d", tz="Europe/Paris"),
      limits=c(data_trial()$start, data_trial()$end)
    ) + ylim(3500, 12000) +
    theme_bw() + theme(legend.position="none")
})

```


### Subset
```{r plot_weight_subset}

renderPlot({
  data_weight() %>%
    filter(genotype == input$genotype) %>%
    ggplot(aes(x=time, y=weight, color=treatment, group=plant_code)) +
    geom_line() +
    geom_hline(aes(yintercept=0.1), linetype=2) +
    scale_color_manual(values=c("#619CFF","#F8766D")) +
    scale_x_datetime(
      date_breaks="1 day", labels=date_format("%d", tz="Europe/Paris"),
      limits=c(data_trial()$start, data_trial()$end)
    ) + ylim(3500, 12000) +
    theme_bw() + theme(legend.position="none")
})

```




Water deficit
=====================================     
   
Row  {.tabset}
-------------------------------------

### All genotypes
```{r plot_stress}

renderPlot({
  data_ftsw() %>%
    ggplot(aes(x=time, y=FTSW, color=treatment, group=interaction(genotype, treatment))) +
    geom_point(alpha=0.3) +
    geom_line(stat="smooth", method="loess", alpha=0.8, size=1) +
    geom_hline(aes(yintercept=input$threshold_ftsw), linetype=2) +  
    scale_color_manual(values=c("#619CFF","#F8766D")) +
    scale_x_datetime(
      date_breaks="1 day", labels=date_format("%d", tz="Europe/Paris"),
      limits=c(data_trial()$start, data_trial()$end)
    ) + ylim(0, 1.2) +
    theme_bw() + theme(legend.position="none")
})

```


### Subset
```{r plot_stress_subset}

renderPlot({
  data_ftsw() %>%
    filter(genotype == input$genotype) %>%
    ggplot(aes(x=time, y=FTSW, color=treatment, group=plant_code)) +
    geom_line() +
    geom_hline(aes(yintercept=input$threshold_ftsw), linetype=2) +
    geom_text_repel(
      data=data_ftsw_label(),
      aes(x=time, FTSW, label=position)
    ) +
    scale_color_manual(values=c("#619CFF","#F8766D")) +
    scale_x_datetime(
      date_breaks="1 day", labels=date_format("%d", tz="Europe/Paris"),
      limits=c(data_trial()$start, data_trial()$end)
    ) + ylim(0, 1.2) +
    theme_bw() + theme(legend.position="none")
})

```


### Interpolation
```{r plot_stress_interpolation}

renderPlot({
  data_ftsw_daily() %>%
    filter(genotype == input$genotype) %>%
    ggplot(aes(x=time, y=FTSW, color=treatment, group=plant_code)) +
    geom_line() +
    geom_hline(aes(yintercept=input$threshold_ftsw), linetype=2) +
    geom_text_repel(
      data=data_ftsw_daily_label(),
      aes(x=time, FTSW, label=position)
    ) +
    scale_color_manual(values=c("#619CFF","#F8766D")) +
    scale_x_datetime(
      date_breaks="1 day", labels=date_format("%d", tz="Europe/Paris"),
      limits=c(data_trial()$start, data_trial()$end)
    ) + ylim(0, 1.2) +
    theme_bw() + theme(legend.position="none")
})

```

