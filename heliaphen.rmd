---
title: "Heliaphen"
output:
  flexdashboard::flex_dashboard:
    source_code: embed
runtime: shiny
---

```{r setup, include=FALSE}
library(lubridate)
library(readr)
library(readxl)
library(plyr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(viridis)
library(plotly)
library(scales)
library(flexdashboard)
library(rheliaphen)
library(shiny)

# options
theme_set(theme_bw())
lim_area <- c(0, 350)

# experiment parameters
data_trial <- reactive({
  read_excel(paste0("data/heliaphen_experiments.xlsx")) %>% 
    mutate(start=ymd(start, tz="Europe/Paris"), end=ymd(end, tz="Europe/Paris")) %>% 
    filter(experiment==input$experiment)
})

list_experiment <- reactive({
  read_excel(paste0("data/heliaphen_experiments.xlsx")) %>% select(experiment) %>% arrange(experiment) %>% .$experiment
})

# design of experiment
data_index <- reactive({
  read_excel(paste0("data/",input$experiment,"/",input$experiment,"_index.xlsx"))
})

# list of genotypes in selected experiment
list_genotype <- reactive({
  data_index() %>% select(genotype) %>% distinct() %>% arrange(genotype) %>% .$genotype
})

# pot weight
data_weight <- reactive({
  read_rds(paste0("data/",input$experiment,"/",input$experiment,"_weight.rds")) 
})

# soil water deficit
data_ftsw <- reactive({
  data_weight() %>%
    soil_water_deficit(
      date_start=data_trial()$start,
      date_end=data_trial()$end,
      weight_dead=data_trial()$weight_dead,
      awc=0.39,
      timing="measure"
    ) 
})

# interpolated soil water deficit
data_ftsw_daily <- reactive({
  data_weight() %>%
    soil_water_deficit(
      date_start=data_trial()$start,
      date_end=data_trial()$end,
      weight_dead=data_trial()$weight_dead,
      awc=0.39,
      timing="daily"
    ) 
})

# table for stressed plant below defined water deficit threshold
table_harvest <- reactive({
  data_ftsw() %>%
    plant_harvest(
      date_start=ymd(as.character(input$date[1]), tz="Europe/Paris"),
      date_end=ymd(as.character(input$date[2]), tz="Europe/Paris"),
      threshold=input$threshold_ftsw
    )
})

# leaf area
data_area_raw <- reactive({
  read_rds(paste0("data/",input$experiment,"/",input$experiment,"_area_raw.rds")) 
})

data_area <- reactive({
  read_rds(paste0("data/",input$experiment,"/",input$experiment,"_area.rds")) 
})

```


Sidebar {.sidebar}
=====================================

----------
### Selection

```{r inputs_design}

# shiny input for file selection (list)
# TODO : read existing dir
renderUI({
  selectInput('experiment', 'Experiment', list_experiment())
})
  
# shiny input for genotype selection (list)
renderUI({
  selectInput('genotype', 'Genotype', list_genotype())
})

# shiny input for interpolation (check)

```

----------
### Harvest

```{r inputs_harvest}
# shiny input for planning date selection
renderUI({
  dateRangeInput('date', label='Dates', start=data_trial()$start, end=data_trial()$end)
})
  
# shiny input for filtering threshold
renderUI({
  sliderInput("threshold_ftsw", label="Threshold", min=0, max=1, value=0.1)
})


```

----------
### Import

```{r inputs_import}
# import raw files

renderUI({
  actionLink("import", "Import (raw files)")  
})

table_import <- eventReactive(input$import, {
  soil_weight(experiment=input$experiment, index=data_index(), date_start=data_trial()$start)
})


# write processed raw files for analysis
renderUI({
  actionLink("write", "Write (weight)")  
})

observeEvent(input$write, {
  write_rds(table_import(), paste0("data/",input$experiment,"/",input$experiment,"_weight.rds"), compress="bz2")  
})


```

----------
### Export

```{r inputs_export}

# setup data download
output$table_download_area <- downloadHandler(
  file = paste0(input$experiment, "_", format(Sys.Date(), "%Y%m%d"),"_area.csv"), 
  content = function(file) {
    write_csv(write_heliaphen(table_harvest())$area, file, na="")
  }
)

renderUI({
  downloadLink('table_download_area', label = 'Download (leaf area)')  
})
  
output$table_download_architecture <- downloadHandler(
  file = paste0(input$experiment, "_", format(Sys.Date(), "%Y%m%d"),"_architecture.csv"), 
  content = function(file) {
    write_csv(write_heliaphen(table_harvest())$architecture, file, na="")
  }
)

renderUI({
  downloadLink('table_download_architecture', label = 'Download (architecture)')
})

```

----------

Design {data-orientation=rows}
=====================================  
    
Row {.data-height=150}
-------------------------------------
    
### Experimental design
```{r plot_design}
# plot experimental design
renderPlotly({
  ggplotly(
    data_index() %>%
      mutate(column=as.factor(column), line=as.factor(line)) %>%
      ggplot(aes(column, line, label=genotype)) +
      geom_tile(aes(fill=genotype), alpha=0.5) +
      geom_point(aes(shape=treatment), size=5, alpha=0.5) +
      scale_shape_manual(values=c(19, 1), guide = "none") +
      labs(x=NULL, y=NULL) + coord_equal() +
      theme(legend.position="none"),
    tooltip=c("x","y","label", "shape")
  )
})

```


Row {data-height=900}
-------------------------------------

### Table of harvestable plants
```{r table_harvest}

renderDataTable(
  table_harvest() %>%
    mutate(
      weight=round(weight, 0),
      FTSW=round(FTSW, 2),
      irrigation=round(irrigation, 0)
    ) %>%
    select(plant_code:irrigation, genotype, treatment),
  options=list(pageLength=10)
)

```


Import {data-orientation=rows}
=====================================  
```{r table_import}

renderDataTable(
  table_import(), options=list(pageLength=10)
)

```



Weight
=====================================     
   
Row  {.tabset}
-------------------------------------

### All genotypes
```{r plot_weight}

renderPlotly({
  ggplotly(
    data_weight() %>%
      ggplot(aes(x=time, y=weight, color=treatment, group=interaction(genotype, treatment), label=plant_code)) +
      geom_point(alpha=0.3) +
      geom_line(stat="smooth", method="loess", alpha=0.8, size=1) +
      geom_hline(aes(yintercept=0.1), linetype=2) +  
      scale_color_manual(values=c("#619CFF","#F8766D")) +
      scale_x_datetime(
        date_breaks="1 day", labels=date_format("%d", tz="Europe/Paris"),
        limits=c(data_trial()$start, data_trial()$end)
      ) + ylim(3500, 12000) +
      theme(legend.position="none"),
    tooltip=c("x","y","label")
  )
})

```


### Subset
```{r plot_weight_subset}

renderPlotly({
  ggplotly(
    data_weight() %>%
      filter(genotype == input$genotype) %>%
      ggplot(aes(x=time, y=weight, color=treatment, group=plant_code, label=plant_code)) +
      geom_line() +
      geom_hline(aes(yintercept=0.1), linetype=2) +
      scale_color_manual(values=c("#619CFF","#F8766D")) +
      scale_x_datetime(
        date_breaks="1 day", labels=date_format("%d", tz="Europe/Paris"),
        limits=c(data_trial()$start, data_trial()$end)
      ) + ylim(3500, 12000) +
      theme(legend.position="none"),
    tooltip=c("x","y","label")
  )
})

```




Water deficit
=====================================     
   
Row  {.tabset}
-------------------------------------

### All genotypes
```{r plot_stress}

renderPlotly({
  ggplotly(
    data_ftsw() %>%
      ggplot(aes(x=time, y=FTSW, color=treatment, group=interaction(genotype, treatment), label=plant_code)) +
      geom_point(alpha=0.3) +
      geom_line(stat="smooth", method="loess", alpha=0.8, size=1) +
      geom_hline(aes(yintercept=input$threshold_ftsw), linetype=2) +  
      scale_color_manual(values=c("#619CFF","#F8766D")) +
      scale_x_datetime(
        date_breaks="1 day", labels=date_format("%d", tz="Europe/Paris"),
        limits=c(data_trial()$start, data_trial()$end)
      ) + ylim(0, 1.2) +
      theme(legend.position="none"),
    tooltip=c("x","y","label")
  )
})

```


### Subset
```{r plot_stress_subset}

renderPlotly({
  ggplotly(
    data_ftsw() %>%
      filter(genotype == input$genotype) %>%
      ggplot(aes(x=time, y=FTSW, color=treatment, group=plant_code, label=plant_code)) +
      geom_line() +
      geom_hline(aes(yintercept=input$threshold_ftsw), linetype=2) +
      scale_color_manual(values=c("#619CFF","#F8766D")) +
      scale_x_datetime(
        date_breaks="1 day", labels=date_format("%d", tz="Europe/Paris"),
        limits=c(data_trial()$start, data_trial()$end)
      ) + ylim(0, 1.2) +
      theme(legend.position="none"),
    tooltip=c("x","y","label")
  )
})

```


### Interpolation
```{r plot_stress_interpolation}

renderPlotly({
  ggplotly(
    data_ftsw_daily() %>%
      filter(genotype == input$genotype) %>%
      ggplot(aes(x=time, y=FTSW, color=treatment, group=plant_code, label=plant_code)) +
      geom_line() +
      geom_hline(aes(yintercept=input$threshold_ftsw), linetype=2) +
      scale_color_manual(values=c("#619CFF","#F8766D")) +
      scale_x_datetime(
        date_breaks="1 day", labels=date_format("%d", tz="Europe/Paris"),
        limits=c(data_trial()$start, data_trial()$end)
      ) + ylim(0, 1.2) +
      theme(legend.position="none"),
    tooltip=c("x","y","label")
  )
})

```

### Data
```{r table_harvest_planning}

# TODO : add filter for selected dates 
renderDataTable(
  data_ftsw() %>%
    filter(
      time >= ymd(as.character(input$date[1]), tz="Europe/Paris"),
      time < ymd(as.character(input$date[2]), tz="Europe/Paris")
      ) %>%
    select(plant_code:irrigation, genotype, treatment),
  options=list(pageLength=10)
)

```


Leaf area
=====================================     

Row  {.tabset}
-------------------------------------

### Leaf profile
```{r plot_leaf_profile}

renderPlotly({
  ggplotly(
    data_area() %>% 
      filter(genotype %in% input$genotype) %>% 
      mutate(time=as.character(time), area=area/100) %>% 
      ggplot(aes(x=area, y=leaf, color=time, group=time, label=time)) +
      geom_path() +
      geom_point(
        data=data_area_raw() %>%
          filter(genotype %in% input$genotype) %>%
          mutate(
            time=as.character(time),
            area=area/100, leaf=as.integer(leaf)
          ), size=1
      ) +
      facet_wrap(~ treatment + plant_code, ncol=6) +
      coord_cartesian(xlim=lim_area) +
      scale_color_viridis(discrete=TRUE, option="plasma", end=0.95) +
      labs(x="Leaf area (cm2)", y="Node") + theme(legend.position="none"),
    tooltip=c("x","y","label")
  )
})



```

### Leaf dynamics
```{r plot_leaf_dynamics}

renderPlotly({
  ggplotly(
    data_area() %>% 
      filter(genotype %in% input$genotype) %>% 
      mutate(area=area/100) %>% 
      ggplot(aes(x=time, y=area, color=leaf, group=leaf, label=leaf)) +
      geom_path() +
      geom_point(
        data=data_area_raw() %>%
          filter(genotype %in% input$genotype) %>% 
          mutate(area=area/100), size=1
      ) + 
      facet_wrap(~ treatment + plant_code, ncol=6) +
      coord_cartesian(ylim=lim_area) +
      scale_color_viridis(option="plasma", end=0.95) +
      scale_x_datetime(
        date_breaks="2 day", labels=date_format("%d", tz="Europe/Paris")
      ) +
      labs(x="Time", y="Leaf area (cm2)") + theme(legend.position="none"),
    tooltip=c("x","y","label")
  )
})

```

### Plant dynamics
```{r plot_plant_dynamics}


```



Expansion
=====================================     


Transpiration
=====================================     

